// Updated with localStorage tracking for rewards
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PiLoyalty App</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; background: #f8f8f8; }
    .card { background: white; padding: 2rem; border-radius: 12px; max-width: 500px; margin: 2rem auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    button { background: #ffcc00; border: none; padding: 1rem 2rem; font-size: 1rem; border-radius: 8px; cursor: pointer; }
    #login-section, #app-content, #directory-section, #rewards-section, #profile-section, #not-in-pi-browser { display: none; }
    .business-card, .reward-card, .profile-card { border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; border-radius: 8px; text-align: left; }
    .clickable { cursor: pointer; color: #0077cc; text-decoration: underline; }
  </style>
</head>
<body>
  <div id="not-in-pi-browser" class="card">
    <h2>Open in Pi Browser</h2>
    <p>This app must be opened inside the Pi Browser to log in and use Pi features.</p>
  </div>

  <div id="login-section" class="card">
    <h2>Welcome to PiLoyalty</h2>
    <p>Login with your Pi Network account to continue.</p>
    <button onclick="loginWithPi()">Login with Pi</button>
  </div>

  <div id="app-content" class="card">
    <h2>Hello, <span id="username"></span>!</h2>
    <p>You are now logged in via Pi Network.</p>
    <p><strong>UID:</strong> <span id="uid"></span></p>
    <button onclick="showDirectory()">Go to Business Directory</button>
    <button onclick="showRewards()">View My Rewards</button>
  </div>

  <div id="directory-section" class="card">
    <h2>Business Directory</h2>
    <div class="business-card clickable" onclick="logVisit('SunGlow Tanning')">
      <strong>SunGlow Tanning</strong><br>
      ‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ (4.5)<br>
      Accepts Pi: ‚úÖ<br>
      Loyalty Offer: Earn 10 Pi for 5 visits
    </div>
    <div class="business-card clickable" onclick="logVisit('Crypto Caf√©')">
      <strong>Crypto Caf√©</strong><br>
      ‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ (4.2)<br>
      Accepts Pi: ‚úÖ<br>
      Loyalty Offer: Buy 4, get 1 coffee free
    </div>
    <div class="business-card clickable" onclick="logVisit('Pi Style Barber')">
      <strong>Pi Style Barber</strong><br>
      ‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ (3.9)<br>
      Accepts Pi: ‚úÖ<br>
      Loyalty Offer: 15% off after 3 visits
    </div>
    <button onclick="goBack()">Back to Home</button>
  </div>

  <div id="rewards-section" class="card">
    <h2>My Rewards</h2>
    <div id="rewards-container"></div>
    <button onclick="goBack()">Back to Home</button>
  </div>

  <div id="profile-section" class="card">
    <h2 id="profile-title">Business Profile</h2>
    <div class="profile-card" id="profile-content"></div>
    <button onclick="showDirectory()">Back to Directory</button>
  </div>

  <script>
    const scopes = ['username', 'payments'];
    const businesses = {
      "SunGlow Tanning": 5,
      "Crypto Caf√©": 4,
      "Pi Style Barber": 3
    };

    function isInPiBrowser() {
  return navigator.userAgent.toLowerCase().includes("pi");
}

    function loginWithPi() {
      Pi.init({ version: "2.0", sandbox: true });
      Pi.authenticate(scopes, onLoginSuccess, onIncompletePaymentFound)
        .then(auth => {
          document.getElementById('login-section').style.display = 'none';
          document.getElementById('app-content').style.display = 'block';
          document.getElementById('username').innerText = auth.user.username;
          document.getElementById('uid').innerText = auth.user.uid;
        })
        .catch(error => {
          alert("Login failed: " + error);
        });
    }

    function logVisit(business) {
      let visits = JSON.parse(localStorage.getItem('rewards')) || {};
      visits[business] = (visits[business] || 0) + 1;
      localStorage.setItem('rewards', JSON.stringify(visits));
      alert(`Visit logged for ${business}`);
    }

    function showRewards() {
      hideAllSections();
      const container = document.getElementById('rewards-container');
      container.innerHTML = '';
      const data = JSON.parse(localStorage.getItem('rewards')) || {};
      for (const [biz, count] of Object.entries(data)) {
        const goal = businesses[biz];
        const percent = Math.min(Math.round((count / goal) * 100), 100);
        container.innerHTML += `
          <div class='reward-card'>
            <strong>${biz}</strong><br>
            ‚úÖ ${count} of ${goal} visits completed<br>
            Progress: ${'‚ñà'.repeat(percent / 10)}${'‚ñë'.repeat(10 - percent / 10)} (${percent}%)<br>
            Reward: ${goal - count > 0 ? `${goal - count} more visits needed` : 'Ready to redeem!'}
          </div>
        `;
      }
      document.getElementById('rewards-section').style.display = 'block';
    }

    function showProfile(name) {
      hideAllSections();
      const content = {
        "SunGlow Tanning": {
          rating: "4.5",
          offer: "Earn 10 Pi for 5 visits",
          description: "Premium tanning salon with exclusive Pi loyalty rewards.",
          acceptsPi: true
        },
        "Crypto Caf√©": {
          rating: "4.2",
          offer: "Buy 4, get 1 coffee free",
          description: "Modern caf√© for crypto lovers. Wi-Fi, lattes, and Pi rewards!",
          acceptsPi: true
        },
        "Pi Style Barber": {
          rating: "3.9",
          offer: "15% off after 3 visits",
          description: "Trendy cuts, crypto talk, and loyalty bonuses in Pi.",
          acceptsPi: true
        }
      };
      const biz = content[name];
      document.getElementById('profile-title').innerText = name;
      document.getElementById('profile-content').innerHTML = `
        ‚≠ê Rating: ${biz.rating} ‚≠ê<br>
        üìú Offer: ${biz.offer}<br>
        üìç Accepts Pi: ${biz.acceptsPi ? '‚úÖ' : '‚ùå'}<br><br>
        üìù ${biz.description}
      `;
      document.getElementById('profile-section').style.display = 'block';
    }

    function goBack() {
      hideAllSections();
      document.getElementById('app-content').style.display = 'block';
    }

    function hideAllSections() {
      document.getElementById('app-content').style.display = 'none';
      document.getElementById('directory-section').style.display = 'none';
      document.getElementById('rewards-section').style.display = 'none';
      document.getElementById('profile-section').style.display = 'none';
    }

    if (isInPiBrowser()) {
      document.getElementById('login-section').style.display = 'block';
    } else {
      document.getElementById('not-in-pi-browser').style.display = 'block';
    }
  </script>
</body>
</html>
